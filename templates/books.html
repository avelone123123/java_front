<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥ - –û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="/" class="logo">
                    <span>–û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞</span>
                </a>
                <ul class="nav-links">
                    <li><a href="/">–ì–ª–∞–≤–Ω–∞—è / –ë–∞—Å—Ç—ã</a></li>
                    <li><a href="/books" class="active">–ö–∞—Ç–∞–ª–æ–≥ / –ö–∞—Ç–∞–ª–æ–≥</a></li>
                    <li th:if="${isAuthenticated}">
                        <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li th:if="${isAuthenticated}">
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" data-tooltip="–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã">–í—ã—Ö–æ–¥ / –®—ã“ì—É</button>
                        </form>
                    </li>
                    <li th:unless="${isAuthenticated}">
                        <a href="/login">–í—Ö–æ–¥</a>
                    </li>
                    <li th:unless="${isAuthenticated}">
                        <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="hero" style="padding: 40px 20px;">
            <h1 style="font-size: 42px;">
                <span>–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥ / –ö—ñ—Ç–∞–ø—Ç–∞—Ä –∫–∞—Ç–∞–ª–æ–≥—ã</span>
            </h1>
            <p>–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –º–∏–ª–ª–∏–æ–Ω—ã –∫–Ω–∏–≥</p>

            <div class="search-box">
                <input type="text" 
                       id="searchInput" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É, ISBN... / –ê—Ç–∞—É—ã, –∞–≤—Ç–æ—Ä—ã, ISBN –±–æ–π—ã–Ω—à–∞ —ñ–∑–¥–µ—É..."
                       autocomplete="off">
                <button class="search-btn" onclick="searchBooks()">
                    –ü–æ–∏—Å–∫ / –Ü–∑–¥–µ—É
                </button>
            </div>
        </section>

        <!-- Loading indicator -->
        <div id="loadingIndicator" style="display: none; text-align: center; padding: 40px;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; color: white; font-size: 18px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥... / –ö—ñ—Ç–∞–ø—Ç–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...</p>
        </div>

        <!-- Books Grid -->
        <div id="booksGrid" class="books-grid"></div>

        <!-- No results message -->
        <div id="noResults" style="display: none; text-align: center; padding: 60px 20px;">

            <h2 style="color: white; margin-bottom: 10px;">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã / –ö—ñ—Ç–∞–ø—Ç–∞—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã</h2>
            <p style="color: rgba(255,255,255,0.8);">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å / –Ü–∑–¥–µ—É —Å“±—Ä–∞–Ω—ã—Å—ã–Ω ”©–∑–≥–µ—Ä—Ç—ñ–ø –∫”©—Ä—ñ“£—ñ–∑</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 –û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã / –ë–∞—Ä–ª—ã“õ “õ“±“õ—ã“õ—Ç–∞—Ä “õ–æ—Ä“ì–∞–ª“ì–∞–Ω.</p>
        </div>
    </footer>

    <!-- Main JavaScript -->
    <script th:src="@{/js/main.js}"></script>
    
    <script>
        const booksGrid = document.getElementById('booksGrid');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noResults = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');

        // –ü–æ–∏—Å–∫ –∫–Ω–∏–≥
        async function searchBooks() {
            const query = searchInput.value.trim();
            if (!query) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å / –Ü–∑–¥–µ—É —Å“±—Ä–∞–Ω—ã—Å—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑', 'warning');
                return;
            }

            showLoading();
            booksGrid.innerHTML = '';
            noResults.style.display = 'none';

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Open Library Search API
                const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=50`);
                const data = await response.json();

                hideLoading();

                if (data.docs && data.docs.length > 0) {
                    displayBooks(data.docs);
                    showToast(`–ù–∞–π–¥–µ–Ω–æ ${data.docs.length} –∫–Ω–∏–≥ / ${data.docs.length} –∫—ñ—Ç–∞–ø —Ç–∞–±—ã–ª–¥—ã`, 'success');
                } else {
                    noResults.style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–Ω–∏–≥ / –ö—ñ—Ç–∞–ø—Ç–∞—Ä–¥—ã —ñ–∑–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–Ω–∏–≥ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadPopularBooks() {
            showLoading();
            booksGrid.innerHTML = '';

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É)
                const subjects = ['fiction', 'science', 'history', 'philosophy', 'art'];
                const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                
                const response = await fetch(`https://openlibrary.org/subjects/${randomSubject}.json?limit=50`);
                const data = await response.json();

                hideLoading();

                if (data.works && data.works.length > 0) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
                    const books = data.works.map(work => ({
                        title: work.title,
                        author_name: work.authors ? work.authors.map(a => a.name) : ['Unknown'],
                        first_publish_year: work.first_publish_year,
                        cover_i: work.cover_id,
                        key: work.key,
                        subject: work.subject ? work.subject.slice(0, 3) : []
                    }));
                    displayBooks(books);
                } else {
                    noResults.style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–Ω–∏–≥ / –ö—ñ—Ç–∞–ø—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ', 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–∏–≥
        function displayBooks(books) {
            booksGrid.innerHTML = '';
            
            books.forEach((book, index) => {
                const bookCard = document.createElement('a');
                bookCard.className = 'book-card';
                bookCard.style.animationDelay = `${index * 0.05}s`;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const bookKey = book.key || (book.cover_edition_key ? `/works/${book.cover_edition_key}` : '');
                bookCard.href = `/book-details?key=${encodeURIComponent(bookKey)}`;

                // –û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏
                const coverUrl = book.cover_i 
                    ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`
                    : 'https://via.placeholder.com/200x300?text=No+Cover';

                // –ê–≤—Ç–æ—Ä—ã
                const authors = Array.isArray(book.author_name) 
                    ? book.author_name.join(', ') 
                    : (book.author_name || 'Unknown Author');

                // –ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                const year = book.first_publish_year || 'N/A';

                // –ñ–∞–Ω—Ä—ã/—Ç–µ–º—ã
                const subjects = Array.isArray(book.subject) 
                    ? book.subject.slice(0, 2).join(', ') 
                    : '';

                bookCard.innerHTML = `
                    <img src="${coverUrl}" 
                         alt="${book.title}" 
                         class="book-cover"
                         onerror="this.src='https://via.placeholder.com/200x300?text=No+Cover'">
                    <div class="book-info">
                        <h3 class="book-title">${book.title}</h3>
                        <p class="book-author">‚úçÔ∏è ${authors}</p>
                        <div class="book-meta">
                            <span>üìÖ ${year}</span>
                            ${subjects ? `<span>üè∑Ô∏è ${subjects}</span>` : ''}
                        </div>
                    </div>
                `;

                booksGrid.appendChild(bookCard);
            });
        }

        function showLoading() {
            loadingIndicator.style.display = 'block';
            booksGrid.style.display = 'none';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
            booksGrid.style.display = 'grid';
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchBooks();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');

        if (searchQuery) {
            searchInput.value = searchQuery;
            searchBooks();
        } else {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadPopularBooks();
        }
    </script>
</body>
</html>
