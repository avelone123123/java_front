<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏ - –û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <style>
        .book-details-container {
            max-width: 1000px;
            margin: 40px auto;
            background: var(--card-gradient);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 48px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        .book-header {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .book-cover-large {
            width: 100%;
            height: 450px;
            object-fit: cover;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .book-info-main h1 {
            font-size: 36px;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-weight: 800;
        }

        .book-author {
            font-size: 20px;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        .book-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .meta-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: var(--border-radius-md);
            font-size: 14px;
        }

        .meta-label {
            font-weight: 600;
            margin-right: 8px;
        }

        .book-description {
            margin: 32px 0;
            line-height: 1.8;
            font-size: 16px;
        }

        .book-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 24px 0;
        }

        .subject-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            transition: all var(--transition-normal);
        }

        .subject-tag:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .book-header {
                grid-template-columns: 1fr;
            }

            .book-details-container {
                padding: 24px;
            }

            .book-meta-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="/" class="logo">
                    <span>–û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞</span>
                </a>
                <ul class="nav-links">
                    <li><a href="/">–ì–ª–∞–≤–Ω–∞—è / –ë–∞—Å—Ç—ã</a></li>
                    <li><a href="/books">–ö–∞—Ç–∞–ª–æ–≥ / –ö–∞—Ç–∞–ª–æ–≥</a></li>
                    <li th:if="${isAuthenticated}">
                        <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li th:if="${isAuthenticated}">
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" data-tooltip="–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã">–í—ã—Ö–æ–¥ / –®—ã“ì—É</button>
                        </form>
                    </li>
                    <li th:unless="${isAuthenticated}">
                        <a href="/login">–í—Ö–æ–¥</a>
                    </li>
                    <li th:unless="${isAuthenticated}">
                        <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Loading indicator -->
        <div id="loadingIndicator" style="display: block; text-align: center; padding: 80px 20px;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; color: white; font-size: 18px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ... / –ö—ñ—Ç–∞–ø —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç –∂“Ø–∫—Ç–µ–ª—É–¥–µ...</p>
        </div>

        <!-- Book Details Container -->
        <div id="bookDetails" class="book-details-container" style="display: none;">
            <a href="/books" class="btn btn-secondary" style="margin-bottom: 24px; display: inline-block;">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É / –ö–∞—Ç–∞–ª–æ–≥“õ–∞ –æ—Ä–∞–ª—É
            </a>

            <div class="book-header">
                <div>
                    <img id="bookCover" class="book-cover-large" alt="Book Cover">
                </div>
                <div class="book-info-main">
                    <h1 id="bookTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <p class="book-author" id="bookAuthor">–ê–≤—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
                    
                    <div class="book-meta-grid" id="bookMetaGrid">
                        <!-- Meta information will be inserted here -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addToLibrary()">
                            –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ / –¢–∞“£–¥–∞—É–ª—ã“ì–∞ “õ–æ—Å—É
                        </button>
                        <a id="readOnlineLink" href="#" target="_blank" class="btn btn-secondary">
                            –ß–∏—Ç–∞—Ç—å –æ–Ω–ª–∞–π–Ω / –û–Ω–ª–∞–π–Ω –æ“õ—É
                        </a>
                    </div>
                </div>
            </div>

            <div class="book-description">
                <h2 style="margin-bottom: 16px; font-size: 24px;">–û–ø–∏—Å–∞–Ω–∏–µ / –°–∏–ø–∞—Ç—Ç–∞–º–∞</h2>
                <p id="bookDescription">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è... / –°–∏–ø–∞—Ç—Ç–∞–º–∞ –∂“Ø–∫—Ç–µ–ª—É–¥–µ...</p>
            </div>

            <div id="bookSubjectsContainer" style="display: none;">
                <h3 style="margin-bottom: 16px; font-size: 20px;">üè∑Ô∏è –¢–µ–º—ã –∏ –∂–∞–Ω—Ä—ã / –¢–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä –º–µ–Ω –∂–∞–Ω—Ä–ª–∞—Ä</h3>
                <div class="book-subjects" id="bookSubjects">
                    <!-- Subjects will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div id="errorMessage" style="display: none; text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üòû</div>
            <h2 style="color: white; margin-bottom: 10px;">–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ / –ö—ñ—Ç–∞–ø —Ç–∞–±—ã–ª–º–∞–¥—ã</h2>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 24px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ / –ö—ñ—Ç–∞–ø —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã</p>
            <a href="/books" class="btn btn-primary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É / –ö–∞—Ç–∞–ª–æ–≥“õ–∞ –æ—Ä–∞–ª—É</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 –û–Ω–ª–∞–π–Ω –ö—ñ—Ç–∞–ø—Ö–∞–Ω–∞. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã / –ë–∞—Ä–ª—ã“õ “õ“±“õ—ã“õ—Ç–∞—Ä “õ–æ—Ä“ì–∞–ª“ì–∞–Ω.</p>
        </div>
    </footer>

    <!-- Main JavaScript -->
    <script th:src="@{/js/main.js(v=2)}"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bookKey = urlParams.get('key');

        async function loadBookDetails() {
            if (!bookKey) {
                showError();
                return;
            }

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ
                const response = await fetch(`https://openlibrary.org${bookKey}.json`);
                if (!response.ok) throw new Error('Book not found');
                
                const book = await response.json();
                // –î–æ–±–∞–≤–ª—è–µ–º key –≤ –æ–±—ä–µ–∫—Ç –∫–Ω–∏–≥–∏
                book.key = bookKey;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–∞—Ö
                let authorNames = 'Unknown Author';
                if (book.authors && book.authors.length > 0) {
                    const authorPromises = book.authors.map(author => 
                        fetch(`https://openlibrary.org${author.author.key}.json`).then(r => r.json())
                    );
                    const authors = await Promise.all(authorPromises);
                    authorNames = authors.map(a => a.name).join(', ');
                }

                displayBookDetails(book, authorNames);
            } catch (error) {
                console.error('Error loading book:', error);
                showError();
            }
        }

        function displayBookDetails(book, authorNames) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–∏–≥—É
            currentBook = book;
            currentBook.authorNames = authorNames; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤
            
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('bookDetails').style.display = 'block';

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('bookTitle').textContent = book.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            document.getElementById('bookAuthor').textContent = authorNames;

            // –û–±–ª–æ–∂–∫–∞
            const coverImg = document.getElementById('bookCover');
            if (book.covers && book.covers.length > 0) {
                coverImg.src = `https://covers.openlibrary.org/b/id/${book.covers[0]}-L.jpg`;
            } else {
                coverImg.src = 'https://via.placeholder.com/300x450?text=No+Cover';
            }
            coverImg.alt = book.title;

            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            const metaGrid = document.getElementById('bookMetaGrid');
            metaGrid.innerHTML = '';

            const metaData = [
                { label: '–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ / –ñ–∞—Ä–∏—è–ª–∞–Ω“ì–∞–Ω –∂—ã–ª—ã', value: book.first_publish_date || book.publish_date || 'N/A' },
                { label: '–ò–∑–¥–∞—Ç–µ–ª—å / –ë–∞—Å–ø–∞–≥–µ—Ä', value: book.publishers ? book.publishers.join(', ') : 'N/A' },
                { label: '–°—Ç—Ä–∞–Ω–∏—Ü / –ë–µ—Ç—Ç–µ—Ä', value: book.number_of_pages || 'N/A' },
                { label: 'ISBN', value: book.isbn_13 ? book.isbn_13[0] : (book.isbn_10 ? book.isbn_10[0] : 'N/A') },
                { label: '–Ø–∑—ã–∫ / –¢—ñ–ª', value: book.languages ? book.languages.map(l => l.key.replace('/languages/', '')).join(', ') : 'N/A' },
                { label: '–†–µ–π—Ç–∏–Ω–≥ / –†–µ–π—Ç–∏–Ω–≥', value: book.ratings_average ? `${book.ratings_average.toFixed(1)}/5` : 'N/A' }
            ];

            metaData.forEach(meta => {
                const metaItem = document.createElement('div');
                metaItem.className = 'meta-item';
                metaItem.innerHTML = `<span class="meta-label">${meta.label}:</span>${meta.value}`;
                metaGrid.appendChild(metaItem);
            });

            // –û–ø–∏—Å–∞–Ω–∏–µ
            let description = '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ / –°–∏–ø–∞—Ç—Ç–∞–º–∞ “õ–æ–ª–∂–µ—Ç—ñ–º—Å—ñ–∑';
            if (book.description) {
                description = typeof book.description === 'string' ? book.description : book.description.value;
            }
            document.getElementById('bookDescription').textContent = description;

            // –¢–µ–º—ã/–∂–∞–Ω—Ä—ã
            if (book.subjects && book.subjects.length > 0) {
                document.getElementById('bookSubjectsContainer').style.display = 'block';
                const subjectsContainer = document.getElementById('bookSubjects');
                subjectsContainer.innerHTML = '';
                
                book.subjects.slice(0, 10).forEach(subject => {
                    const tag = document.createElement('span');
                    tag.className = 'subject-tag';
                    tag.textContent = subject;
                    subjectsContainer.appendChild(tag);
                });
            }

            // –°—Å—ã–ª–∫–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫
            const readLink = document.getElementById('readOnlineLink');
            if (book.key) {
                const workId = book.key.replace('/works/', '');
                readLink.href = `/reader/${workId}`;
                readLink.target = '_self';
            }
        }

        function showError() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
        }

        let currentBook = null;

        async function addToLibrary() {
            if (!currentBook) {
                showToast('–ö–Ω–∏–≥–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ / –ö—ñ—Ç–∞–ø ”ô–ª—ñ –∂“Ø–∫—Ç–µ–ª–º–µ–≥–µ–Ω', 'warning');
                return;
            }

            try {
                showLoading();
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
                const bookData = {
                    openLibraryId: currentBook.key,
                    title: currentBook.title,
                    author: currentBook.authorNames || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä',
                    description: currentBook.description?.value || currentBook.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                    coverUrl: currentBook.covers && currentBook.covers[0] 
                        ? `https://covers.openlibrary.org/b/id/${currentBook.covers[0]}-L.jpg` 
                        : null,
                    publishYear: currentBook.first_publish_date ? 
                        parseInt(currentBook.first_publish_date.match(/\d{4}/)?.[0]) : null,
                    isbn: currentBook.isbn_13?.[0] || currentBook.isbn_10?.[0] || null
                };

                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏:', bookData);

                const response = await fetch('/api/library/add-from-openlibrary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookData)
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

                if (response.status === 401 || response.status === 403) {
                    hideLoading();
                    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É / –ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—ñ“£—ñ–∑', 'warning');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                hideLoading();

                if (response.ok) {
                    showToast(result.message || '–ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!', 'success');
                } else {
                    showToast(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadBookDetails();
    </script>
</body>
</html>
